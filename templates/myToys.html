<template>
 
    <style>

        .frm-brinq{
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .frm-brinq *{
            padding: 8px;
            margin: 10px;
            width: 97%;
        }

        .modal-content{
            width: 90vw;

        }

        .no-margin, canvas{
            margin: 0 !important;
            padding: 0 !important;
        }

        legend{
            width: auto !important;
        }

    </style>

    <div class="frm-brinq">
           
        <fieldset>
            <legend>Adicione um Brinquedo</legend>
            <div class="inline">
                <input type="text" id="edtBusca" placeholder="Digite sua busca aqui">
                <button id="btnBusca">Busca</button>
            </div>
            <table id="tblToys"></table>
        </fieldset>

        <fieldset>
            <legend> Brinquedos Selecionados</legend>
            <table id="tblMyToys"></table>
        </fieldset>

        <button id="btnContrata">Contratar</button>

    </div>

</template>

<script>        

    viewMyToys()

    function viewToys(){

        const params = new Object;
            params.nome = document.querySelector('#edtBusca').value;
            
        const myPromisse = queryDB(params,22)

        myPromisse.then((resolve)=>{

            const tab = document.querySelector('#tblToys')
            tab.innerHTML = ''
            if(resolve.trim() != ""){            
                tab.innerHTML = '<tr><th>Nome</th><th>Tam.</th><th>Qtd.</th><th>Foto</th></tr>'
                function addTD(val,cn=''){
                    const td = document.createElement('td')
                    td.innerHTML = val
                    if(cn != ''){
                        td.className = cn
                    }
                    return td
                }

                const json = JSON.parse(resolve);

                for(let i=0; i<json.length; i++){
                    const tr = document.createElement('tr')
                    tr.appendChild(addTD(json[i].id,'hide'))
                    tr.appendChild(addTD(json[i].nome))
                    tr.appendChild(addTD(json[i].tamanho))
                    tr.appendChild(addTD(json[i].qtd))
                    tr.appendChild(addTD(json[i].sobre,'hide'))
                    tr.appendChild(addTD(`<canvas width="300" height="300" id="cnvImg${i}"></canvas>`,'no-margin'))
                    tr.title=json[i].sobre
                    tr.dados = json[i]
                    tab.appendChild(tr)
                    loadImg(json[i].img,"cnvImg"+ i)

                }

            }
            
        });


    }

    function viewMyToys(){

        const params = new Object;
            params.id_festa = data.id;
            
        const myPromisse = queryDB(params,20)

        myPromisse.then((resolve)=>{

            const tab = document.querySelector('#tblMyToys')
            tab.innerHTML = ''
            if(resolve.trim() != ""){            
                tab.innerHTML = '<tr><th>Nome</th><th>Tam.</th><th>Qtd.</th><th>Foto</th></tr>'
                function addTD(val,cn=''){
                    const td = document.createElement('td')
                    td.innerHTML = val
                    if(cn != ''){
                        td.className = cn
                    }
                    return td
                }

                const json = JSON.parse(resolve);

                for(let i=0; i<json.length; i++){
                    const tr = document.createElement('tr')
                    tr.appendChild(addTD(json[i].id,'hide'))
                    tr.appendChild(addTD(json[i].nome))
                    tr.appendChild(addTD(json[i].tamanho))
                    tr.appendChild(addTD(json[i].qtd))
                    tr.appendChild(addTD(`<canvas width="300" height="300" id="cnvImg${i}"></canvas>`,'no-margin'))
                    tr.title=json[i].sobre
                    tr.dados = json[i]
                    tab.appendChild(tr)
                    loadImg(json[i].img,"cnvImg"+ i)

                }
                CountSizes()

            }
            
        });


    }

    function CountSizes(){
        const params = new Object;
            params.id_festa = data.id;
            
        const myPromisse = queryDB(params,23)

        myPromisse.then((resolve)=>{
            out = new Object
                out.P = 0
                out.M = 0
                out.G = 0
            if(resolve.trim() != ""){ 
                sizes = JSON.parse(resolve)

                for(let i=0; i<sizes.length; i++){
                    out.P = sizes[i].tam == 'P' ? parseInt(sizes[i].qtd) : out.P
                    out.M = sizes[i].tam == 'M' ? parseInt(sizes[i].qtd) : out.M
                    out.G = sizes[i].tam == 'G' ? parseInt(sizes[i].qtd) : out.G
//                    console.log(sizes[i])
                }

                modal_data.reserva = out
                modal_data.saldo = new Object
                modal_data.saldo.P = parseInt(modal_data.P) - out.P
                modal_data.saldo.M = parseInt(modal_data.M) - out.M
                modal_data.saldo.G = parseInt(modal_data.G) - out.G
                console.log(modal_data)    

            }

        })


    }


    document.querySelector('#btnBusca').addEventListener('click',()=>{

        viewToys()

    })

    document.querySelector('#tblToys').addEventListener('click',(e)=>{
        data = e.target.parentNode.dados
        data.origin = 'myToys'
        data.evento = modal_data
        console.log(data)
        openHTML('addMyToy.html','over',data.nome, data)
    })

    document.querySelector('#tblMyToys').addEventListener('click',(e)=>{

        if (confirm('Deseja realmente deletar este brinquedo da lista?')) {
            
            const params = new Object;
                params.id = e.target.parentNode.dados.id;

            const myPromisse = queryDB(params,21)
            myPromisse.then((resolve)=>{
                viewMyToys()
            });         

        }            
        
    })


</script>    