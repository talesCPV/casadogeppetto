<template>
 
    <style>

        .modal-content {
            width: 350px ; 
            height: auto;
            padding: 20px;
            opacity: 90%;
        }

        .frm-login{
            display: flex;
            flex-direction: column;
            align-items: center;

        }

        .frm-login *{
            padding: 8px;
            margin: 10px;
            width: 80%;
        }

        #lblNovoUsuario{
            font-size: 12px;
        }

    </style>

    <div class="frm-login">
       
        <a href="#" class="logo"><img src="assets/logo.png" alt=""></a>

        <input type="text"     id="edtUser" placeholder="Usuário">
        <input type="password" id="edtPass" placeholder="Senha"  >
        <button id="btnLogin"> LOGIN </button>
        
        <hr size="1" width="90%">

        <a href="#" id="lblNovoUsuario">Novo usuário?</a>


    </div>

</template>

<script>        

    const label = document.querySelector('#menu-login')
//    localStorage.clear();
    menu_login()


    function menu_login(){
        if(localStorage.getItem('access') == null){
            label.innerHTML = 'Logout'
        }else{
            label.innerHTML = 'Login'
            const frame = localStorage.getItem("frame")
            localStorage.clear(); 
            localStorage.setItem('frame',frame)
            loadContent(frame)
            btnClose.click();
        }
    }


    document.querySelector('#btnLogin').addEventListener('click',()=>{

        let user = document.querySelector('#edtUser').value
        let hash = document.querySelector('#edtPass').value.getHash(30)

        const params = new Object;
            params.username = user;
            params.hash = hash;

        const data = new URLSearchParams();        
        data.append("cod", 0);
        data.append("token", '');
        data.append("params", JSON.stringify(params));

        const myRequest = new Request("files/query_db.php",{
            method : "POST",
            body : data
        });

        const myPromisse = new Promise((resolve,reject) =>{

            fetch(myRequest)
            .then(function (response){

                if (response.status === 200) { 
                    resolve(response.text());
                } else { 
                    reject(new Error("Houve algum erro na comunicação com o servidor"));
                } 

            });            

        });

        myPromisse.then((resolve)=>{

            if(resolve.trim() != ""){
                const json = JSON.parse(resolve);
                
                localStorage.setItem("id",json[0].id);
                localStorage.setItem("username",json[0].username);
                localStorage.setItem("nome",json[0].nome);
                localStorage.setItem("access",json[0].access);
                loadContent(localStorage.getItem("frame"))
            }else{
                alert("Usuário ou senha inválido!");
                localStorage.clear();                
            }     
            label.innerHTML = 'Logout'  
            btnClose.click();
        });

        closeMenu()
        loadContent(localStorage.getItem("frame")) 

    })

    document.querySelector('#lblNovoUsuario').addEventListener('click',()=>{

        openHTML('new_user.html','pop-up','Novo Usuario')

    })


</script>    